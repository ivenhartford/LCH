name: CI - Full Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # This job always runs and reports success/failure for branch protection
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: CI Status Check
        run: |
          echo "âœ… CI pipeline initiated"
          echo "Running full test suite for backend and frontend"

  backend-tests:
    runs-on: ubuntu-latest
    needs: check-status

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov

    - name: Run backend tests
      env:
        FLASK_ENV: testing
        SECRET_KEY: test-secret-key-for-ci
        DATABASE_URL: sqlite:///test.db
      run: |
        cd backend
        pytest tests/ -v --cov=app --cov-report=term-missing

    - name: Backend tests passed
      run: echo "âœ… Backend tests passed!"

  frontend-tests:
    runs-on: ubuntu-latest
    needs: check-status

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run frontend tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false --passWithNoTests
      env:
        CI: true

    - name: Build frontend
      run: |
        cd frontend
        npm run build
      env:
        CI: false

    - name: Frontend tests passed
      run: echo "âœ… Frontend tests passed!"

  all-tests-complete:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
    - name: All tests passed
      run: |
        echo "================================================"
        echo "âœ… All tests passed successfully!"
        echo "âœ… Backend: PASSED"
        echo "âœ… Frontend: PASSED"
        echo "================================================"
        echo "Ready to merge! ðŸŽ‰"
